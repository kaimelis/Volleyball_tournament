<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>BeachBros Volleyball Tournament</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <style>
            .tab-content {
                display: none;
            }
            .tab-content.active {
                display: block;
            }
            .tab-button {
                padding: 10px 20px;
                cursor: pointer;
            }
            .active-tab {
                border-bottom: 2px solid blue;
                font-weight: bold;
            }
            .main-tab-content {
                display: none;
            }
            .main-tab-content.active {
                display: block;
            }
        </style>
    </head>
    <body class="bg-gray-50">
        <div class="container mx-auto p-4 max-w-6xl">
            <div class="bg-white rounded-lg shadow-sm">
                <!-- Main Tabs -->
                <div class="border-b">
                    <div class="flex gap-4 px-4">
                        <button id="all-main-button" class="tab-button active-tab" onclick="showMainTab('all')">All</button>
                        <button id="light-main-button" class="tab-button" onclick="showMainTab('light')">Light</button>
                        <button id="hard-main-button" class="tab-button" onclick="showMainTab('hard')">Hard</button>
                    </div>
                </div>
    
                <!-- Template for tournament sections -->
                <template id="tournament-section-template">
                    <div class="border-b">
                        <div class="flex gap-4 px-4">
                            <button class="tab-button active-tab" data-action="manage">Manage</button>
                            <button class="tab-button" data-action="matches">Matches</button>
                            <button class="tab-button" data-action="standings">Standings</button>
                        </div>
                    </div>
                    
                    <!-- Manage Content -->
                    <div class="tab-content active p-4" data-content="manage">
                        <div class="mb-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-bold">Beach Volleyball Tournament Groups</h2>
                                <button 
                                    class="text-blue-500 hover:text-blue-700 px-4 py-2 rounded border border-blue-500 hover:border-blue-700 toggle-team-management"
                                >
                                    Show Team Management
                                </button>
                            </div>
    
                            <div class="team-management-section hidden space-y-4">
                                <div class="team-management p-4 border rounded-lg bg-gray-50">
                                    <h3 class="font-semibold mb-2">Add New Team</h3>
                                    <div class="flex gap-2">
                                        <input 
                                            type="text" 
                                            class="new-team-input flex-1 px-3 py-2 border rounded"
                                            placeholder="Enter team name"
                                        >
                                        <button 
                                            class="add-team-btn bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                                        >
                                            Add Team
                                        </button>
                                    </div>
                                </div>
    
                                <div class="teams-list-container p-4 border rounded-lg">
                                    <h3 class="font-semibold mb-2">Current Teams</h3>
                                    <div class="teams-list grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                        <!-- Teams will be listed here -->
                                    </div>
                                </div>
                            </div>
    
                            <div>
                                <h3 class="font-semibold mb-2">Demo</h3>
                                <div class="flex space-x-2">
                                    <button class="generate-button flex-1 bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">
                                        Generate Groups & Schedule
                                    </button>
                                    <button class="random-scores-button flex-1 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
                                        Generate Random Scores
                                    </button>
                                    <button class="clear-button flex-1 bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
                                        Delete Tournament
                                    </button>
                                </div>
                                <h3 class="font-semibold mt-4 mb-2">Configuration</h3>
                                <button class="reshuffle-button w-full bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">
                                    Reshuffle Teams
                                </button>
                            </div>
                        </div>
    
                        <div class="groups-container grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Groups will be inserted here -->
                        </div>
                    </div>
    
                    <!-- Matches Content -->
                    <div class="tab-content p-4" data-content="matches">
                        <div class="matches-container grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            <!-- Matches will be inserted here -->
                        </div>
                    </div>
    
                    <!-- Standings Content -->
                    <div class="tab-content p-4" data-content="standings">
                        <div class="space-y-6">
                            <div class="bg-white rounded-lg p-4 border">
                                <h3 class="text-lg font-semibold mb-4">Tournament Standings (Wins)</h3>
                                <div class="wins-standings space-y-2">
                                    <!-- Wins standings will be inserted here -->
                                </div>
                            </div>
    
                            <div class="bg-white rounded-lg p-4 border">
                                <h3 class="text-lg font-semibold mb-4">Point Differential Rankings</h3>
                                <div class="differential-standings space-y-2">
                                    <!-- Point differential standings will be inserted here -->
                                </div>
                            </div>
    
                            <div class="bg-white rounded-lg p-4 border">
                                <h3 class="text-lg font-semibold mb-4">Group Rankings</h3>
                                <div class="group-standings space-y-6">
                                    <!-- Group standings will be inserted here -->
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
    
                <!-- Main sections -->
                <div id="all-main-tab" class="main-tab-content active" data-courts="6"></div>
                <div id="light-main-tab" class="main-tab-content" data-courts="3"></div>
                <div id="hard-main-tab" class="main-tab-content" data-courts="3"></div>
            </div>
        </div>
    
        <!-- Switch Team Modal -->
        <div id="switch-team-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                <h3 class="text-lg font-semibold mb-4">Switch Team Group</h3>
                <div class="mb-4">
                    <p class="text-gray-600 mb-2">Select new group for: <span id="selected-team" class="font-semibold"></span></p>
                    <select id="new-group-select" class="w-full p-2 border rounded">
                        <!-- Options will be populated dynamically -->
                    </select>
                </div>
                <div class="flex justify-end gap-2">
                    <button 
                        onclick="closeSwitchTeamModal()" 
                        class="px-4 py-2 text-gray-600 hover:text-gray-800 rounded"
                    >
                        Cancel
                    </button>
                    <button 
                        onclick="switchTeamGroup()" 
                        class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                    >
                        Switch
                    </button>
                </div>
            </div>
        </div>

    <script>

        const tournamentStates = {
            all: {
                activeTeams: [],
                groups: Array(6).fill().map(() => []),
                matches: [],
                teamStats: {},
                isFirstGeneration: true
            },
            light: {
                activeTeams: [],
                groups: Array(3).fill().map(() => []),
                matches: [],
                teamStats: {},
                isFirstGeneration: true
            },
            hard: {
                activeTeams: [],
                groups: Array(3).fill().map(() => []),
                matches: [],
                teamStats: {},
                isFirstGeneration: true
            }
        };

        let currentTournamentType = 'all';
        // Default teams
        const defaultTeams = {
            all: [
                "Spike Masters", "Beach Kings", "Sand Storm", "Wave Riders",
                "Net Ninjas", "Coastal Crew", "Sun Setters", "Beach Blast",
                "Sand Devils", "Ocean's 6", "Tidal Force", "Palm Beach",
                "Sandy Aces", "Beach Breakers", "Surf Squad", "Volleyball Vic's",
                "Sea Smashers", "Coast Guards", "Beach Bros", "Sand Stars", 
                "Wave Warriors", "Beach Legends", "Net Nobles", "Sand Sharks"
            ],
            light: [
                "Spike Masters", "Beach Kings", "Sand Storm", "Wave Riders",
                "Net Ninjas", "Coastal Crew", "Sun Setters", "Beach Blast",
                "Sand Devils", "Ocean's 6", "Tidal Force", "Palm Beach"
            ],
            hard: [
                "Sandy Aces", "Beach Breakers", "Surf Squad", "Volleyball Vic's",
                "Sea Smashers", "Coast Guards", "Beach Bros", "Sand Stars", 
                "Wave Warriors", "Beach Legends", "Net Nobles", "Sand Sharks"
            ]
        };


        let activeTeams = [];
        let groups = Array(6).fill().map(() => []);
        let matches = [];
        let teamStats = {};
        let isFirstGeneration = true;
        let selectedTeam = null;
        let selectedGroupIndex = null;

    function initializeTournamentSections() {
            const template = document.getElementById('tournament-section-template');
            ['all', 'light', 'hard'].forEach(type => {
                const container = document.getElementById(`${type}-main-tab`);
                container.innerHTML = template.innerHTML;

                // Add event listeners for this section
                setupEventListeners(container, type);
            });
        }

        function setupEventListeners(container, type) {
            // Tab navigation
            container.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => {
                    const action = button.dataset.action;
                    showSubTab(type, action);
                });
            });

            // Team management toggle
            container.querySelector('.toggle-team-management').addEventListener('click', () => {
                toggleTeamManagement(type);
            });

            // Add team button
            container.querySelector('.add-team-btn').addEventListener('click', () => {
                addTeam(type);
            });

            // Action buttons
            container.querySelector('.generate-button').addEventListener('click', () => {
                toggleTournament(type);
            });

            container.querySelector('.random-scores-button').addEventListener('click', () => {
                generateRandomScores(type);
            });

            container.querySelector('.reshuffle-button').addEventListener('click', () => {
                reshuffleTeams(type);
            });

            container.querySelector('.clear-button').addEventListener('click', () => {
                clearTournamentData(type);
            });

            // Enter key for new team input
            container.querySelector('.new-team-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addTeam(type);
                }
            });
        }


    // Add these new functions at the top of your script section
    function showMainTab(type) {
            currentTournamentType = type;
            
            // Update tab buttons
            document.querySelectorAll('[id$="-main-button"]').forEach(button => {
                button.classList.remove('active-tab');
            });
            document.getElementById(`${type}-main-button`).classList.add('active-tab');

            // Show selected content
            document.querySelectorAll('.main-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${type}-main-tab`).classList.add('active');

            // Update displays
            updateTeamsList(type);
            updateGroupsDisplay(type);
            updateMatchesDisplay(type);
            updateStandings(type);
        }


        function showSubTab(type, tabName) {
            const mainTab = document.getElementById(`${type}-main-tab`);
            
            // Update tab buttons
            mainTab.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active-tab');
            });
            mainTab.querySelector(`[data-action="${tabName}"]`).classList.add('active-tab');

            // Show selected content
            mainTab.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            mainTab.querySelector(`[data-content="${tabName}"]`).classList.add('active');

            // Update standings if necessary
            if (tabName === 'standings') {
                updateStandings(type);
            }
        }

    function showTab(tabName) {
        // Hide all tab contents
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });

        // Show the selected tab content
        document.getElementById(`${tabName}-tab`).classList.add('active');

        // Remove the active class from all tab buttons
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active-tab');
        });

        // Add the active class to the selected tab button
        document.getElementById(`${tabName}-button`).classList.add('active-tab');

        // Update standings if the standings tab is selected
        if (tabName === 'standings') {
            updateStandings();
        }
    }

    function toggleTeamManagement(type) {
            const mainTab = document.getElementById(`${type}-main-tab`);
            const section = mainTab.querySelector('.team-management-section');
            const button = mainTab.querySelector('.toggle-team-management');
            
            if (section.classList.contains('hidden')) {
                section.classList.remove('hidden');
                button.textContent = 'Hide Team Management';
            } else {
                section.classList.add('hidden');
                button.textContent = 'Show Team Management';
            }
        }


    function generateGroups(type) {
        const state = tournamentStates[type];
        const numCourts = type === 'all' ? 6 : 3;
        
        // Create empty groups array with proper number of courts
        state.groups = Array(numCourts).fill().map(() => []);
        
        // Shuffle active teams
        const shuffledTeams = [...state.activeTeams].sort(() => Math.random() - 0.5);
        
        // Calculate teams per group
        const teamsPerGroup = Math.ceil(shuffledTeams.length / numCourts);
        
        // Distribute teams
        shuffledTeams.forEach((team, index) => {
            const groupIndex = Math.floor(index / teamsPerGroup);
            if (groupIndex < numCourts) {
                state.groups[groupIndex].push(team);
            }
        });

        generateMatches(type);
        updateGroupsDisplay(type);
        updateMatchesDisplay(type);
        updateStandings(type);
    }

    function toggleTournament(type) {
        const state = tournamentStates[type];
        
        if (state.isFirstGeneration) {
            state.activeTeams = [...defaultTeams[type]];
            state.isFirstGeneration = false;
        }

        state.teamStats = {};
        state.activeTeams.forEach(team => {
            state.teamStats[team] = {
                wins: 0,
                pointsScored: 0,
                pointsConceded: 0,
                differential: 0
            };
        });

        generateGroups(type);
        updateTeamsList(type);
        updateGroupsDisplay(type);
        updateMatchesDisplay(type);
        updateStandings(type);
        saveToLocalStorage();
        }

    function addTeam(type) {
        const mainTab = document.getElementById(`${type}-main-tab`);
        const input = mainTab.querySelector('.new-team-input');
        const teamName = input.value.trim();
        
        if (teamName && !tournamentStates[type].activeTeams.includes(teamName)) {
            tournamentStates[type].activeTeams.push(teamName);
            input.value = '';
            updateTeamsList(type);
            initializeTeamStats(type);
            generateGroups(type);
            saveToLocalStorage();
        }
    }

    function initializeTeamStats(type) {
        const state = tournamentStates[type];
        if (!state) return;
        
        state.teamStats = {};
        state.activeTeams.forEach(team => {
            state.teamStats[team] = {
                wins: 0,
                pointsScored: 0,
                pointsConceded: 0,
                differential: 0
            };
        });
    }
    function reshuffleTeams(type) {
        const state = tournamentStates[type];
        const numCourts = type === 'all' ? 6 : 3;
        
        let teams = [...state.activeTeams];
        for (let i = teams.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [teams[i], teams[j]] = [teams[j], teams[i]];
        }
        state.activeTeams = teams;

        const teamsPerGroup = Math.floor(teams.length / numCourts);
        const extraTeams = teams.length % numCourts;
        
        state.groups = Array(numCourts).fill().map((_, index) => {
            const startIndex = index * teamsPerGroup + Math.min(index, extraTeams);
            const groupSize = teamsPerGroup + (index < extraTeams ? 1 : 0);
            return teams.slice(startIndex, startIndex + groupSize);
        });

        initializeTeamStats(type);
        updateTeamsList(type);
        updateGroupsDisplay(type);
        generateMatches(type);
        updateMatchesDisplay(type);
        updateStandings(type);
        saveToLocalStorage();
    }


    function removeTeam(type, teamName) {
            tournamentStates[type].activeTeams = tournamentStates[type].activeTeams.filter(team => team !== teamName);
            updateTeamsList(type);
            initializeTeamStats(type);
            generateGroups(type);
            saveToLocalStorage();
        }

    function updateTeamsList(type) {
        const mainTab = document.getElementById(`${type}-main-tab`);
        const container = mainTab.querySelector('.teams-list');
        
        container.innerHTML = tournamentStates[type].activeTeams.map(team => `
            <div class="flex justify-between items-center p-2 bg-gray-100 rounded">
                <span class="flex-grow">${team}</span>
                <button 
                    onclick="removeTeam('${type}', '${team}')" 
                    class="text-red-500 hover:text-red-700 px-2"
                >
                    Ã—
                </button>
            </div>
        `).join('');
    }

    function generateRandomScores(type) {
        const state = tournamentStates[type];
        state.matches.forEach(match => {
            while (true) {
                const score1 = Math.floor(Math.random() * 22);
                const score2 = Math.floor(Math.random() * 22);

                if ((score1 === 21 && score1 - score2 >= 2) || 
                    (score2 === 21 && score2 - score1 >= 2)) {
                    match.score1 = score1;
                    match.score2 = score2;
                    break;
                }
            }
        });

        updateMatchesDisplay(type);
        updateStandings(type);
        saveToLocalStorage();
    }

    function generateMatches(type) {
        if (!type || !tournamentStates[type]) return;
        
        const state = tournamentStates[type];
        const numCourts = type === 'all' ? 6 : 3;
        state.matches = [];
        const matchesPerGroup = 6;
        const matchDuration = 20;

        state.groups.forEach((group, courtIndex) => {
            if (group.length >= 2) {
                for (let i = 0; i < group.length; i++) {
                    for (let j = i + 1; j < group.length; j++) {
                        state.matches.push({
                            court: courtIndex + 1,
                            team1: group[i],
                            team2: group[j],
                            score1: 0,
                            score2: 0,
                            startTime: new Date()
                        });
                    }
                }
            }
        });

        const startTime = new Date();
        startTime.setHours(9, 0, 0, 0);

        for (let matchIndex = 0; matchIndex < matchesPerGroup; matchIndex++) {
            const matchTime = new Date(startTime);
            matchTime.setMinutes(matchTime.getMinutes() + (matchIndex * matchDuration));

            state.groups.forEach((_, courtIndex) => {
                const courtMatches = state.matches.filter(m => m.court === courtIndex + 1);
                if (matchIndex < courtMatches.length) {
                    courtMatches[matchIndex].startTime = new Date(matchTime);
                }
            });
        }
        }


    function updateGroupsDisplay(type) {
        const mainTab = document.getElementById(`${type}-main-tab`);
        const container = mainTab.querySelector('.groups-container');
        container.innerHTML = tournamentStates[type].groups.map((group, groupIndex) => `
            <div class="border rounded-lg p-4">
                <h3 class="font-semibold mb-2">Court ${groupIndex + 1}</h3>
                <ul class="space-y-2">
                    ${group.map(team => `
                        <li class="flex justify-between items-center p-2 bg-gray-50 rounded">
                            <span>${team}</span>
                            <button 
                                onclick="showSwitchTeamModal('${team}', ${groupIndex})" 
                                class="text-blue-500 hover:text-blue-700 text-sm px-2 py-1 rounded border border-blue-500 hover:border-blue-700"
                            >
                                Switch Group
                            </button>
                        </li>
                    `).join('')}
                </ul>
            </div>
        `).join('');
    }

    function formatTime(date) {
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function updateMatchesDisplay(type) {
        const mainTab = document.getElementById(`${type}-main-tab`);
        if (!mainTab) return;
        
        const container = mainTab.querySelector('.matches-container');
        if (!container) return;
        
        const state = tournamentStates[type];
        if (!state || !state.groups || !state.matches) return;

        container.innerHTML = state.groups.map((groupTeams, groupIndex) => {
            const groupMatches = state.matches.filter(
                match => groupTeams.includes(match.team1) || groupTeams.includes(match.team2)
            );
            return `
                <div class="border rounded-lg p-4">
                    <h3 class="font-semibold mb-2">Court ${groupIndex + 1}</h3>
                    <div class="text-sm text-gray-600 mb-4">
                        <div class="font-medium mb-1">Teams:</div>
                        ${groupTeams.map(team => `
                            <div class="whitespace-nowrap overflow-hidden text-ellipsis">
                                ${team}
                            </div>
                        `).join('')}
                    </div>
                    <div class="space-y-4">
                        ${groupMatches.map((match) => {
                            const overallMatchIndex = state.matches.findIndex(m => m === match);
                            return `
                                <div class="bg-gray-50 p-3 rounded-lg">
                                    <div class="flex justify-between text-sm text-gray-600 mb-2">
                                        <span>Court ${match.court}</span>
                                        <span>${formatTime(match.startTime)}</span>
                                    </div>
                                    <div class="space-y-2">
                                        <div class="flex items-center gap-2 whitespace-nowrap overflow-hidden">
                                            <span class="flex-grow text-sm font-medium overflow-hidden text-ellipsis">
                                                ${match.team1}
                                            </span>
                                            <input
                                                type="number"
                                                min="0"
                                                value="${match.score1 ?? 0}"
                                                onchange="updateScore('${type}', ${overallMatchIndex}, this.value, null)"
                                                class="text-center w-20 flex-shrink-0 border rounded p-1"
                                                placeholder="Score"
                                            >
                                        </div>
                                        <div class="flex items-center gap-2 whitespace-nowrap overflow-hidden">
                                            <span class="flex-grow text-sm font-medium overflow-hidden text-ellipsis">
                                                ${match.team2}
                                            </span>
                                            <input
                                                type="number"
                                                min="0"
                                                value="${match.score2 ?? 0}"
                                                onchange="updateScore('${type}', ${overallMatchIndex}, null, this.value)"
                                                class="text-center w-20 flex-shrink-0 border rounded p-1"
                                                placeholder="Score"
                                            >
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }).join('');
    }

    function updateScore(type, matchIndex, score1, score2) {
        const state = tournamentStates[type];
        const match = state.matches[matchIndex];
        
        if (!match) return;

        if (score1 !== null) match.score1 = parseInt(score1) || 0;
        if (score2 !== null) match.score2 = parseInt(score2) || 0;
        
        [match.team1, match.team2].forEach(team => {
            if (!state.teamStats[team]) {
                state.teamStats[team] = { wins: 0, pointsScored: 0, pointsConceded: 0, differential: 0 };
            }
        });

        state.teamStats[match.team1].pointsScored += match.score1;
        state.teamStats[match.team1].pointsConceded += match.score2;
        state.teamStats[match.team2].pointsScored += match.score2;
        state.teamStats[match.team2].pointsConceded += match.score1;

        if (match.score1 > match.score2) {
            state.teamStats[match.team1].wins += 1;
        } else if (match.score2 > match.score1) {
            state.teamStats[match.team2].wins += 1;
        }

        [match.team1, match.team2].forEach(team => {
            state.teamStats[team].differential = 
                state.teamStats[team].pointsScored - state.teamStats[team].pointsConceded;
        });

        updateMatchesDisplay(type);
        updateStandings(type);
        saveToLocalStorage();
    }


    function updateStandings(type) {
   const mainTab = document.getElementById(`${type}-main-tab`);
   const winsContainer = mainTab.querySelector('.wins-standings');
   const diffContainer = mainTab.querySelector('.differential-standings');
   const groupsContainer = mainTab.querySelector('.group-standings');
   const state = tournamentStates[type];

   // Reset all team stats
   Object.keys(state.teamStats).forEach(team => {
       state.teamStats[team] = {
           wins: 0,
           pointsScored: 0,
           pointsConceded: 0,
           differential: 0
       };
   });

   // Recalculate all stats
   state.matches.forEach(match => {
       if (match.score1 !== null && match.score2 !== null) {
           state.teamStats[match.team1].pointsScored += match.score1;
           state.teamStats[match.team1].pointsConceded += match.score2;
           state.teamStats[match.team2].pointsScored += match.score2;
           state.teamStats[match.team2].pointsConceded += match.score1;

           if (match.score1 > match.score2) {
               state.teamStats[match.team1].wins += 1;
           } else if (match.score2 > match.score1) {
               state.teamStats[match.team2].wins += 1;
           }
       }
   });

   // Calculate differentials
   Object.keys(state.teamStats).forEach(team => {
       state.teamStats[team].differential =
           state.teamStats[team].pointsScored - state.teamStats[team].pointsConceded;
   });

   // Update wins standings
   const winsSorted = Object.entries(state.teamStats)
       .sort(([, a], [, b]) => b.wins - a.wins);

   winsContainer.innerHTML = winsSorted.map(([team, stats], index) => `
       <div class="flex justify-between items-center p-2 bg-gray-100 rounded">
           <span>${index + 1}. ${team}</span>
           <span class="font-semibold">${stats.wins} wins</span>
       </div>
   `).join('');

   // Update differential standings
   const diffSorted = Object.entries(state.teamStats)
       .sort(([, a], [, b]) => b.differential - a.differential);

   diffContainer.innerHTML = diffSorted.map(([team, stats], index) => `
       <div class="grid grid-cols-4 items-center p-2 bg-gray-100 rounded gap-2">
           <span>${index + 1}. ${team}</span>
           <span class="text-green-600">Scored: ${stats.pointsScored}</span>
           <span class="text-red-600">Conceded: ${stats.pointsConceded}</span>
           <span class="font-semibold text-right">
               Diff: ${stats.differential > 0 ? '+' : ''}${stats.differential}
           </span>
       </div>
   `).join('');

   // Update group standings
   groupsContainer.innerHTML = state.groups.map((groupTeams, groupIndex) => {
       const groupStats = groupTeams.map(team => ({
           team,
           ...state.teamStats[team]
       })).sort((a, b) => b.wins - a.wins || b.differential - a.differential);

       return `
           <div class="bg-white rounded-lg p-4 border mb-4">
               <h3 class="font-semibold mb-2">Group ${groupIndex + 1}</h3>
               ${groupStats.map((stats, index) => `
                   <div class="flex justify-between items-center p-2 bg-gray-100 rounded">
                       <span>${index + 1}. ${stats.team}</span>
                       <span class="font-semibold">${stats.wins} wins</span>
                       <span class="text-green-600">Scored: ${stats.pointsScored}</span>
                       <span class="text-red-600">Conceded: ${stats.pointsConceded}</span>
                       <span class="font-semibold text-right">
                           Diff: ${stats.differential > 0 ? '+' : ''}${stats.differential}
                       </span>
                   </div>
               `).join('')}
           </div>
       `;
   }).join('');
}

    function showSwitchTeamModal(team, currentGroupIndex) {
        selectedTeam = team;
        selectedGroupIndex = currentGroupIndex;
        
        const modal = document.getElementById('switch-team-modal');
        const teamSpan = document.getElementById('selected-team');
        const groupSelect = document.getElementById('new-group-select');
        
        teamSpan.textContent = team;
        
        // Populate group options
        groupSelect.innerHTML = groups.map((group, index) => 
            index !== currentGroupIndex ? 
            `<option value="${index}">Court ${index + 1}</option>` : 
            ''
        ).join('');
        
        modal.classList.remove('hidden');
    }

    function closeSwitchTeamModal() {
        const modal = document.getElementById('switch-team-modal');
        modal.classList.add('hidden');
        selectedTeam = null;
        selectedGroupIndex = null;
    }

    function switchTeamGroup() {
        if (!selectedTeam || !currentTournamentType) return;
        
        const newGroupIndex = parseInt(document.getElementById('new-group-select').value);
        const state = tournamentStates[currentTournamentType];
        
        state.groups[selectedGroupIndex] = state.groups[selectedGroupIndex].filter(team => team !== selectedTeam);
        state.groups[newGroupIndex].push(selectedTeam);
        
        generateMatches(currentTournamentType);
        updateGroupsDisplay(currentTournamentType);
        updateMatchesDisplay(currentTournamentType);
        updateStandings(currentTournamentType);
        saveToLocalStorage();
        
        closeSwitchTeamModal();
    }
    
    function loadFromLocalStorage() {
        const savedData = localStorage.getItem('volleyballTournament');
        if (!savedData) return false;
        
        try {
            const loadedData = JSON.parse(savedData);
            
            // Initialize default state if data is missing
            ['all', 'light', 'hard'].forEach(type => {
                if (!loadedData[type]) {
                    loadedData[type] = {
                        activeTeams: [],
                        groups: Array(type === 'all' ? 6 : 3).fill().map(() => []),
                        matches: [],
                        teamStats: {},
                        isFirstGeneration: true
                    };
                }

                tournamentStates[type] = {
                    ...loadedData[type],
                    matches: (loadedData[type].matches || []).map(match => ({
                        ...match,
                        startTime: new Date(match.startTime),
                        score1: match.score1 ?? 0,
                        score2: match.score2 ?? 0
                    }))
                };
                
                updateTeamsList(type);
                updateGroupsDisplay(type);
                updateMatchesDisplay(type);
                updateStandings(type);
            });
            
            return true;
        } catch (error) {
            console.error('Error loading saved data:', error);
            return false;
        }
        }
    function saveToLocalStorage() {
    const dataToSave = {};
    Object.entries(tournamentStates).forEach(([type, state]) => {
        dataToSave[type] = {
            ...state,
            matches: state.matches.map(match => ({
                ...match,
                startTime: match.startTime.toISOString()
            }))
        };
    });
    
    localStorage.setItem('volleyballTournament', JSON.stringify(dataToSave));
}


    function clearTournamentData(type) {
        tournamentStates[type] = {
            activeTeams: [],
            groups: Array(type === 'all' ? 6 : 3).fill().map(() => []),
            matches: [],
            teamStats: {},
            isFirstGeneration: true
        };
        
        updateTeamsList(type);
        updateGroupsDisplay(type);
        updateMatchesDisplay(type);
        updateStandings(type);
        saveToLocalStorage();
    }

    document.addEventListener('DOMContentLoaded', () => {
    initializeTournamentSections();
    const loaded = loadFromLocalStorage();
    if (!loaded) {
        Object.keys(tournamentStates).forEach(type => {
            toggleTournament(type);
        });
    }
});
    </script>
</body>
</html>